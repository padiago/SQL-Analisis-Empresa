-- CASO PRACTICO:

-- ANALISIS EXPLORATORIO:
SELECT
    COUNT(DISTINCT ACCOUNT) AS CLIENTES,
    COUNT(PROFIT) AS NUMERO_PEDIDOS,
    AVG(PROFIT) AS MEDIA_BENEFICIO,
    AVG(MAINTENANCE+SUPPORT) AS MEDIA_BENEFICIO_POSTVENTA,
    SUM(UNITS_SOLD) AS TOTAL_UNIDADES_VENDIDAS,
    AVG(UNITS_SOLD) AS MEDIA_UNIDADES_VENDIDAS,
    MIN(QUARTER) AS TRIMESTRE_MAS_ANTIGUO,
    MAX(QUARTER) AS TRIMESTRE_MAS_NUEVO
FROM SALES;

SELECT
    A.INDUSTRY,
    COUNT(S.PROFIT) AS PEDIDOS
FROM SALES AS S
    JOIN ACCCOUNTS AS A ON S.ACCOUNT=A.ACCOUNT
GROUP BY A.INDUSTRY;


CREATE OR REPLACE VIEW COSTES_POSTVENTA_IPG AS
    SELECT
        A.INDUSTRY,
        SUM(S.MAINTENANCE+S.SUPPORT) AS BENEFICIOS_POSTVENTA,
        SUM(S.PRODUCT) AS BENEFICIOS_VENTA,
        SUM(S.UNITS_SOLD) AS UNIDADES_VENDIDAS
    FROM SALES AS S
        JOIN ACCCOUNTS AS A ON S.ACCOUNT=A.ACCOUNT
    GROUP BY A.INDUSTRY;    


SELECT
    AVG(BENEFICIOS_POSTVENTA) AS MEDIA_BENEFICIOS_POSTVENTA,
    AVG(BENEFICIOS_VENTA) AS MEDIA_BENEFICIOS_VENTA,
    AVG(UNIDADES_VENDIDAS) AS MEDIA_UNIDADES_VENDIDAS
FROM COSTES_POSTVENTA_IPG;

SELECT 'MINIMO_BENEFICIOS_POSTVENTA' AS METRICA,
       (SELECT BENEFICIOS_POSTVENTA FROM COSTES_POSTVENTA_IPG ORDER BY BENEFICIOS_POSTVENTA ASC LIMIT 1) AS VALOR,
       (SELECT Industry FROM COSTES_POSTVENTA_IPG ORDER BY BENEFICIOS_POSTVENTA ASC LIMIT 1) AS INDUSTRIA

UNION ALL

SELECT 'MAXIMO_BENEFICIOS_POSTVENTA',
       (SELECT BENEFICIOS_POSTVENTA FROM COSTES_POSTVENTA_IPG ORDER BY BENEFICIOS_POSTVENTA DESC LIMIT 1),
       (SELECT Industry FROM COSTES_POSTVENTA_IPG ORDER BY BENEFICIOS_POSTVENTA DESC LIMIT 1)

UNION ALL

SELECT 'MINIMO_BENEFICIOS_VENTA',
       (SELECT BENEFICIOS_VENTA FROM COSTES_POSTVENTA_IPG ORDER BY BENEFICIOS_VENTA ASC LIMIT 1),
       (SELECT Industry FROM COSTES_POSTVENTA_IPG ORDER BY BENEFICIOS_VENTA ASC LIMIT 1)

UNION ALL

SELECT 'MAXIMO_BENEFICIOS_VENTA',
       (SELECT BENEFICIOS_VENTA FROM COSTES_POSTVENTA_IPG ORDER BY BENEFICIOS_VENTA DESC LIMIT 1),
       (SELECT Industry FROM COSTES_POSTVENTA_IPG ORDER BY BENEFICIOS_VENTA DESC LIMIT 1)

UNION ALL

SELECT 'MINIMO_UNIDADES_VENDIDAS',
       (SELECT UNIDADES_VENDIDAS FROM COSTES_POSTVENTA_IPG ORDER BY UNIDADES_VENDIDAS ASC LIMIT 1),
       (SELECT Industry FROM COSTES_POSTVENTA_IPG ORDER BY UNIDADES_VENDIDAS ASC LIMIT 1)

UNION ALL

SELECT 'MAXIMO_UNIDADES_VENDIDAS',
       (SELECT UNIDADES_VENDIDAS FROM COSTES_POSTVENTA_IPG ORDER BY UNIDADES_VENDIDAS DESC LIMIT 1),
       (SELECT Industry FROM COSTES_POSTVENTA_IPG ORDER BY UNIDADES_VENDIDAS DESC LIMIT 1);


-- DESARROLLO DE ANALISIS:
-- MEDIA POR INDUSTRIA:
CREATE OR REPLACE VIEW MEDIA_COSTES_POSTVENTA_IPG AS
    SELECT
        A.INDUSTRY,
        AVG(S.MAINTENANCE+S.SUPPORT) AS MEDIA_BENEFICIOS_POSTVENTA,
        AVG(S.PRODUCT) AS MEDIA_BENEFICIOS_VENTA,
        AVG(S.UNITS_SOLD) AS MEDIA_UNIDADES_VENDIDAS
    FROM SALES AS S
        JOIN ACCCOUNTS AS A ON S.ACCOUNT=A.ACCOUNT
    GROUP BY A.INDUSTRY;

SELECT *
FROM MEDIA_COSTES_POSTVENTA_IPG;


SELECT
    MIN(MEDIA_BENEFICIOS_POSTVENTA) AS MINIMO_MEDIA_BENEFICIOS_POSTVENTA,
    MAX(MEDIA_BENEFICIOS_POSTVENTA) AS MAXIMO_MEDIA_BENEFICIOS_POSTVENTA,
    MIN(MEDIA_BENEFICIOS_VENTA) AS MINIMO_MEDIA_BENEFICIOS_VENTA,
    MAX(MEDIA_BENEFICIOS_VENTA) AS MAXIMO_MEDIA_BENEFICIOS_VENTA,
    MIN(MEDIA_UNIDADES_VENDIDAS) AS MINIMO_MEDIA_UNIDADES_VENDIDAS,
    MAX(MEDIA_UNIDADES_VENDIDAS) AS MAXIMO_MEDIA_UNIDADES_VENDIDAS
FROM MEDIA_COSTES_POSTVENTA_IPG;

-- POR INDUSTRIA POR UNIDAD VENDIDA:

CREATE OR REPLACE VIEW BENEFICIO_UNITARIO_IPG AS
    SELECT
        A.INDUSTRY,
        (SUM(S.MAINTENANCE+S.SUPPORT)/SUM(S.UNITS_SOLD)) AS BENEFICIO_POST_UNIDAD,
        (SUM(S.PRODUCT)/SUM(S.UNITS_SOLD)) AS BENEFICIO_VENTA_UNIDAD
    FROM SALES AS S
        JOIN ACCCOUNTS AS A ON S.ACCOUNT=A.ACCOUNT
    GROUP BY A.INDUSTRY;

SELECT * FROM BENEFICIO_UNITARIO_IPG;

SELECT
    MIN(BENEFICIO_POST_UNIDAD) AS MINIMO_BENEFICIO_POST,
    MAX(BENEFICIO_POST_UNIDAD) AS MAXIMO_BENEFICIO_POST,
    MIN(BENEFICIO_VENTA_UNIDAD) AS MINIMO_BENEFICIO_VENTA,
    MAX(BENEFICIO_VENTA_UNIDAD) AS MAXIMO_BENEFICIO_VENTA
FROM BENEFICIO_UNITARIO_IPG;

-- SEGMENTACION:

-- DECIDIMOS QUE INDUSTRIAS VAN A SER SOBRE LAS QUE TENER MAS FOCO:


SELECT 'PERCENTIL25_BENEFICIO_POST_UNIDAD' AS METRICA,
       APPROX_PERCENTILE(BENEFICIO_POST_UNIDAD, 0.25) AS VALOR,
       'BENEFICIO_UNITARIO_IPG' AS TABLA
FROM BENEFICIO_UNITARIO_IPG

UNION ALL

SELECT 'PERCENTIL75_BENEFICIO_POST_UNIDAD',
       APPROX_PERCENTILE(BENEFICIO_POST_UNIDAD, 0.75),
       'BENEFICIO_UNITARIO_IPG'
FROM BENEFICIO_UNITARIO_IPG

UNION ALL

SELECT 'PERCENTIL25_BENEFICIO_VENTA_UNIDAD',
       APPROX_PERCENTILE(BENEFICIO_VENTA_UNIDAD, 0.25),
       'BENEFICIO_UNITARIO_IPG'
FROM BENEFICIO_UNITARIO_IPG

UNION ALL

SELECT 'PERCENTIL75_BENEFICIO_VENTA_UNIDAD',
       APPROX_PERCENTILE(BENEFICIO_VENTA_UNIDAD, 0.75),
       'BENEFICIO_UNITARIO_IPG'
FROM BENEFICIO_UNITARIO_IPG

-- Percentiles de MEDIA_COSTES_POSTVENTA_IPG
UNION ALL

SELECT 'PERCENTIL25_MEDIA_BENEFICIOS_POSTVENTA',
       APPROX_PERCENTILE(MEDIA_BENEFICIOS_POSTVENTA, 0.25),
       'MEDIA_COSTES_POSTVENTA_IPG'
FROM MEDIA_COSTES_POSTVENTA_IPG

UNION ALL

SELECT 'PERCENTIL75_MEDIA_BENEFICIOS_POSTVENTA',
       APPROX_PERCENTILE(MEDIA_BENEFICIOS_POSTVENTA, 0.75),
       'MEDIA_COSTES_POSTVENTA_IPG'
FROM MEDIA_COSTES_POSTVENTA_IPG

UNION ALL

SELECT 'PERCENTIL25_MEDIA_BENEFICIOS_VENTA',
       APPROX_PERCENTILE(MEDIA_BENEFICIOS_VENTA, 0.25),
       'MEDIA_COSTES_POSTVENTA_IPG'
FROM MEDIA_COSTES_POSTVENTA_IPG

UNION ALL

SELECT 'PERCENTIL75_MEDIA_BENEFICIOS_VENTA',
       APPROX_PERCENTILE(MEDIA_BENEFICIOS_VENTA, 0.75),
       'MEDIA_COSTES_POSTVENTA_IPG'
FROM MEDIA_COSTES_POSTVENTA_IPG

UNION ALL

SELECT 'PERCENTIL25_MEDIA_UNIDADES_VENDIDAS',
       APPROX_PERCENTILE(MEDIA_UNIDADES_VENDIDAS, 0.25),
       'MEDIA_COSTES_POSTVENTA_IPG'
FROM MEDIA_COSTES_POSTVENTA_IPG

UNION ALL

SELECT 'PERCENTIL75_MEDIA_UNIDADES_VENDIDAS',
       APPROX_PERCENTILE(MEDIA_UNIDADES_VENDIDAS, 0.75),
       'MEDIA_COSTES_POSTVENTA_IPG'
FROM MEDIA_COSTES_POSTVENTA_IPG;

-- ETAPA SEGMENTACION:

WITH SEGMENTACION AS(
    SELECT
        U.INDUSTRY AS INDUSTRIA,
        U.BENEFICIO_POST_UNIDAD AS BENEFICIO_UNIDAD,
        M.MEDIA_BENEFICIOS_VENTA AS MEDIA_BENEFICIOS
    FROM BENEFICIO_UNITARIO_IPG AS U
        JOIN MEDIA_COSTES_POSTVENTA_IPG AS M ON U.INDUSTRY=M.INDUSTRY
)
SELECT
    INDUSTRIA,
    CASE
        WHEN BENEFICIO_UNIDAD > 130 AND MEDIA_BENEFICIOS>3100 THEN 'ALTA'
        WHEN BENEFICIO_UNIDAD > 85 AND MEDIA_BENEFICIOS>2500 THEN 'MEDIA'
        ELSE 'BAJA'
    END AS "IMPORTANCIA",
    BENEFICIO_UNIDAD,
    MEDIA_BENEFICIOS
FROM SEGMENTACION;

-- NOS FIJAMOS EN LAS OPORTUNIDADES FUTURAS EN LAS INDUSTRIAS IMPORTANTES QUE O NO TIENEN OPORTUNIDADES O SON MUY INICIALES PARA HABLAR CON SUS COMERCIALES:

SELECT
    A.INDUSTRY,
    A.ACCOUNT,
    A.ACCOUNT_EXECUTIVE,
    CASE
        WHEN F.OPPORTUNITY_AGE>150 OR F.FORECAST>500000 THEN 'ACTUAR'
        WHEN F.OPPORTUNITY_AGE>50 OR F.FORECAST>250000 THEN 'REVISAR'
        WHEN F.OPPORTUNITY_AGE IS NULl THEN 'INICIAR CONTACTOS'
        ELSE 'PREGUNTA'
    END AS "ANALISIS",
    F.FORECAST,
    F.OPPORTUNITY_AGE
FROM ACCCOUNTS AS A
    LEFT JOIN FORECASTS AS F ON A.ACCOUNT=F.ACCOUNT
WHERE (A.INDUSTRY IN ('Biotech and Pharmaceutical', 'Law', 'Hospitality', 'Home Services'))
    AND (F.PREDICTION_CATEGORY='Pipeline' OR F.PREDICTION_CATEGORY IS NULL );